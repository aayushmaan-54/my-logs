---
import { getCollection, render, type CollectionEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostMeta from '@/components/PostMeta.astro';
import EditPost from '@/components/EditPost.astro';
import BackButton from '@/components/BackButton.astro';
import BackToTopButton from '@/components/BackToTopButton.astro';
import ShareLinks from '@/components/ShareLinks.astro';
import { Icon } from 'astro-icon/components';
import { SITE } from '@/site.config';
import { slugifyStr } from '@/utils/text/slugify';
import getPostPath from '@/utils/content/getPostPath';

export interface Props {
  post: CollectionEntry<'short_reads'>;
}

export async function getStaticPaths() {
  const shortReads = await getCollection(
    'short_reads',
    ({ data }) => !data.draft,
  );
  const postResult = shortReads.map(shortRead => {
    const fullPath = getPostPath(
      shortRead.id,
      shortRead.filePath,
      shortRead.collection,
      shortRead.data.slug,
    );

    const slug = fullPath.replace('/short-reads/', '');

    return {
      params: {
        slug,
      },
      props: { post: shortRead },
    };
  });

  return postResult;
}

const { post } = Astro.props;

const {
  title,
  author,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  hideEditPost,
} = post.data;

const { Content } = await render(post);

let ogImageUrl: string | undefined;

if (!ogImageUrl && SITE.dynamicOgImage) {
  ogImageUrl = `${getPostPath(
    post.id,
    post.filePath,
    post.collection,
    post.data.slug,
  )}/og.png`;
}

const ogImage = ogImageUrl
  ? new URL(ogImageUrl, Astro.url.origin).href
  : undefined;

const layoutProps = {
  title,
  author,
  ogImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  scrollSmooth: true,
  showNav: false,
};
---

<BaseLayout {...layoutProps}>
  <div class='mt-12 mb-4'>
    <BackButton />
  </div>

  <main
    id='main-content'
    class:list={[
      'mx-auto w-full max-w-app px-4 pb-12',
      { 'mt-8': !SITE.showBackButton },
    ]}
    data-pagefind-body
  >
    <h1
      class='inline-block text-2xl font-semibold text-foreground-primary sm:text-3xl'
    >
      <span transition:name={slugifyStr(title)}>{title}</span>
    </h1>

    <div class='my-2 mb-16 text-sm'>
      <div class='flex items-center gap-2'>
        <PostMeta
          {pubDatetime}
          {modDatetime}
          {timezone}
          size='sm'
          text={post.body || ''}
        />
        <span
          aria-hidden='true'
          class:list={[
            'max-sm:hidden',
            { hidden: !SITE.editPost.enabled || hideEditPost },
          ]}>|</span
        >
        <EditPost {hideEditPost} {post} class='max-sm:hidden' />
      </div>
    </div>

    <article
      id='article'
      class='app-prose mx-auto mt-8 max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)'
    >
      <Content />
    </article>

    <hr class='my-8 border-dashed' />

    <EditPost class='sm:hidden' {hideEditPost} {post} />

    <BackToTopButton />
    <div class='mb-4 -ml-4'>
      <BackButton />
    </div>
    <ShareLinks />
  </main>
</BaseLayout>

<template id='clipboard-icon-template'>
  <Icon name='tabler:clipboard' class='h-4 w-4' />
</template>

<template id='clipboard-check-icon-template'>
  <Icon name='tabler:clipboard-check' class='h-4 w-4' />
</template>

<script is:inline data-astro-rerun>
  function createProgressBar() {
    const progressContainer = document.createElement('div');
    progressContainer.className =
      'progress-container fixed top-0 z-10 h-1 w-full bg-primary';

    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar h-1 w-0 bg-foreground-primary';
    progressBar.id = 'myBar';

    progressContainer.appendChild(progressBar);
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  function updateScrollProgress() {
    document.addEventListener('scroll', () => {
      const winScroll =
        document.body.scrollTop || document.documentElement.scrollTop;
      const height =
        document.documentElement.scrollHeight -
        document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      if (document) {
        const myBar = document.getElementById('myBar');
        if (myBar) {
          myBar.style.width = scrolled + '%';
        }
      }
    });
  }
  updateScrollProgress();

  function addHeadingLinks() {
    const headings = Array.from(
      document.querySelectorAll('h2, h3, h4, h5, h6'),
    );

    for (const heading of headings) {
      heading.classList.add('group');
      const link = document.createElement('a');
      if (!heading.id) return;
      link.className =
        'heading-link ms-2 no-underline opacity-75 md:opacity-0 md:group-hover:opacity-100 md:focus:opacity-100';
      link.href = '#' + heading.id;

      const span = document.createElement('span');
      span.ariaHidden = 'true';
      span.className = 'heading-hash';
      span.innerText = '#';
      link.appendChild(span);
      heading.appendChild(link);
    }
  }
  addHeadingLinks();

  function attachCopyButtons() {
    const codeBlocks = Array.from(document.querySelectorAll('pre'));

    const clipboardHTML =
      document.getElementById('clipboard-icon-template')?.innerHTML || '';
    const checkHTML =
      document.getElementById('clipboard-check-icon-template')?.innerHTML || '';

    for (const codeBlock of codeBlocks) {
      if (codeBlock.parentElement.classList.contains('code-block-wrapper'))
        continue;

      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper relative group';

      const computedStyle = window.getComputedStyle(codeBlock);
      const shikiVars = [
        '--shiki-light',
        '--shiki-light-bg',
        '--shiki-dark',
        '--shiki-dark-bg',
      ];
      shikiVars.forEach(varName => {
        const value = computedStyle.getPropertyValue(varName);
        if (value) {
          wrapper.style.setProperty(varName, value);
        }
      });

      codeBlock.parentNode.insertBefore(wrapper, codeBlock);
      wrapper.appendChild(codeBlock);

      const filenameSpan = codeBlock.querySelector(
        'span[class*="-top-[28px]"]',
      );
      if (filenameSpan) {
        wrapper.appendChild(filenameSpan);
      }

      const copyButton = document.createElement('button');
      copyButton.className = `copy-code absolute end-2 top-2 z-20 opacity-100 md:opacity-0 md:group-hover:opacity-100 focus:opacity-100 rounded bg-primary border border-border p-1.5 text-foreground-primary transition-all hover:bg-primary/80`;
      copyButton.setAttribute('aria-label', 'Copy code');
      copyButton.setAttribute('title', 'Copy');

      copyButton.innerHTML = `
        <div class="icon-default">${clipboardHTML}</div>
        <div class="icon-copied hidden text-green-500">${checkHTML}</div>
      `;

      wrapper.appendChild(copyButton);

      copyButton.addEventListener('click', async () => {
        const codeElement = codeBlock.querySelector('code');
        if (!codeElement) return;

        const lines = Array.from(codeElement.querySelectorAll('.line'));
        const filteredLines = lines
          .filter(
            line =>
              !(
                line.classList.contains('diff') &&
                line.classList.contains('remove')
              ),
          )
          .map(line => line.textContent || '')
          .join('\n');

        const text = filteredLines || codeElement.innerText || '';
        await navigator.clipboard.writeText(text);

        const defaultIcon = copyButton.querySelector('.icon-default');
        const copiedIcon = copyButton.querySelector('.icon-copied');

        defaultIcon.classList.add('hidden');
        copiedIcon.classList.remove('hidden');
        copyButton.setAttribute('title', 'Copied');

        setTimeout(() => {
          defaultIcon.classList.remove('hidden');
          copiedIcon.classList.add('hidden');
          copyButton.setAttribute('title', 'Copy');
        }, 2000);
      });
    }
  }

  attachCopyButtons();

  document.addEventListener('astro:after-swap', attachCopyButtons);

  document.addEventListener('astro:after-swap', () =>
    window.scrollTo({ left: 0, top: 0, behavior: 'instant' }),
  );
</script>
