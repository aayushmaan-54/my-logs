---
import '@pagefind/default-ui/css/ui.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContentLayout from '@/layouts/ContentLayout.astro';
import { SITE } from '@/site.config';

const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : '/';
const backUrlKey = SITE.browserStorage.backUrl;
---

<BaseLayout title='search'>
  <ContentLayout pageTitle='Search'>
    <div
      id='pagefind-search'
      transition:persist
      data-backurl={backUrl}
      data-config-key={backUrlKey}
    >
    </div>
  </ContentLayout>
</BaseLayout>

<script>
  function initSearch() {
    const pageFindSearch: HTMLElement | null =
      document.querySelector('#pagefind-search');
    if (!pageFindSearch) return;

    const storageKey = pageFindSearch.dataset.configKey;
    if (!storageKey) return;

    const params = new URLSearchParams(window.location.search);
    const onIdle = window.requestIdleCallback || (cb => setTimeout(cb, 1));

    onIdle(async () => {
      // @ts-expect-error - pagefind has no type definitions
      const { PagefindUI } = await import('@pagefind/default-ui');

      if (import.meta.env.DEV) {
        pageFindSearch.innerHTML = `
          <div class="text-sm text-error py-1 mb-6">
            <p>Search unavailable in dev mode. Run <code class="text-foreground-primary font-mono text-xs bg-foreground-muted/20 px-1.5 py-0.5 rounded">npm run dev:index</code> first.</p>
          </div>
        `;
      }

      const search = new PagefindUI({
        element: '#pagefind-search',
        showSubResults: true,
        showImages: false,
        processTerm: function (queryParams: string) {
          params.set('q', queryParams);
          history.replaceState(history.state, '', '?' + params.toString());

          const backUrl = pageFindSearch?.dataset?.backurl;
          sessionStorage.setItem(storageKey, backUrl + '?' + params.toString());

          return queryParams;
        },
      });

      const query = params.get('q');
      if (query) {
        search.triggerSearch(query);
      }

      const searchInput = document.querySelector('.pagefind-ui__search-input');
      const clearButton = document.querySelector('.pagefind-ui__search-clear');
      searchInput?.addEventListener('input', resetSearchParam);
      clearButton?.addEventListener('click', resetSearchParam);

      function resetSearchParam(e: Event) {
        if ((e.target as HTMLInputElement)?.value.trim() === '') {
          history.replaceState(history.state, '', window.location.pathname);
        }
      }
    });
  }

  document.addEventListener('astro:after-swap', () => {
    const pagefindSearch = document.querySelector('#pagefind-search');
    if (pagefindSearch && pagefindSearch.querySelector('form')) return;
    initSearch();
  });

  initSearch();
</script>

<style is:global>
  #pagefind-search {
    --pagefind-ui-font: var(--font-sans);
    --pagefind-ui-text: var(--foreground-primary);
    --pagefind-ui-background: var(--primary);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--foreground-secondary);
    --pagefind-ui-tag: var(--secondary);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    form::before {
      background-color: var(--foreground-primary);
    }

    input {
      font-weight: 400;
      border: 1px solid var(--border);
    }

    input:focus-visible {
      outline: 1px solid var(--foreground-secondary);
    }

    .pagefind-ui__result-title a {
      color: var(--foreground-secondary);
      outline-offset: 1px;
      outline-color: var(--foreground-secondary);
    }

    .pagefind-ui__result-title a:focus-visible,
    .pagefind-ui__search-clear:focus-visible {
      text-decoration-line: none;
      outline-width: 2px;
      outline-style: dashed;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 0;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:before {
      font-family: system-ui;
    }
  }
</style>
