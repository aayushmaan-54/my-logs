---
import Link from '@/components/Link.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContentLayout from '@/layouts/ContentLayout.astro';
---

<BaseLayout title='subscribe'>
  <ContentLayout pageTitle='Subscribe'>
    <p class='my-2 mb-4'>
      Get notified when I publish something new. No newsletter, no digest, no
      marketing content - just an email when there's a new post.
    </p>

    <span class='text-foreground-muted'>
      Usually a few times a year.
      <Link
        href='/unsubscribe'
        class='underline decoration-1 underline-offset-4'
      >
        Unsubscribe
      </Link>
      anytime.
    </span>

    <form id='subscribe-form' class='mt-10'>
      <input
        id='email-input'
        name='email'
        type='email'
        class='block w-full max-w-sm rounded-md border border-border bg-foreground-muted/10 px-3 py-2 text-foreground-primary ring-offset-foreground-secondary/20 placeholder:text-foreground-muted focus:outline-none focus-visible:ring-2 focus-visible:ring-foreground-secondary/20 focus-visible:ring-offset-2 focus-visible:outline-none'
        placeholder='your@email.com'
        autocomplete='email'
        required
      />
      <button
        type='submit'
        id='subscribe-btn'
        class='mt-3 cursor-pointer rounded-md bg-foreground-primary px-4 py-2 text-primary transition-colors hover:opacity-95 disabled:cursor-not-allowed disabled:opacity-50'
      >
        Subscribe
      </button>
    </form>

    <div id='message' class='mt-4 hidden'></div>
  </ContentLayout>
</BaseLayout>

<script>
  const form = document.getElementById('subscribe-form') as HTMLFormElement;
  const emailInput = document.getElementById('email-input') as HTMLInputElement;
  const submitBtn = document.getElementById(
    'subscribe-btn',
  ) as HTMLButtonElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const email = emailInput.value.trim();

    if (!email) {
      showMessage('Please enter your email address', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';
    messageDiv.classList.add('hidden');

    try {
      const response = await fetch('/api/subscribe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (response.ok) {
        showMessage(data.message || 'Successfully subscribed!', 'success');
        emailInput.value = '';
      } else {
        showMessage(
          data.error || 'Failed to subscribe. Please try again.',
          'error',
        );
      }
    } catch (error) {
      console.error('Subscribe error:', error);
      showMessage('An error occurred. Please try again later.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Subscribe';
    }
  });

  function showMessage(message: string, type: 'success' | 'error') {
    messageDiv.textContent = message;
    messageDiv.classList.remove('hidden');

    if (type === 'success') {
      messageDiv.className =
        'mt-4 p-3 rounded-md bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
    } else {
      messageDiv.className =
        'mt-4 p-3 rounded-md bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
    }
  }
</script>
