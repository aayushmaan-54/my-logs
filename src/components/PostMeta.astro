---
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';
import { SITE } from '@/site.config';
import type { CollectionEntry } from 'astro:content';
import getReadingTime from '@/utils/text/getReadingTime';

dayjs.extend(utc);
dayjs.extend(timezone);

export interface Props {
  class?: string;
  size?: 'sm' | 'lg';
  timezone: CollectionEntry<'blogs' | 'short_reads'>['data']['timezone'];
  pubDatetime: CollectionEntry<'blogs' | 'short_reads'>['data']['pubDatetime'];
  modDatetime: CollectionEntry<'blogs' | 'short_reads'>['data']['modDatetime'];
  text: string;
}

const {
  pubDatetime,
  modDatetime,
  size = 'sm',
  class: className = '',
  timezone: postTimezone,
  text,
} = Astro.props;

const isModified =
  modDatetime instanceof Date && modDatetime.getTime() > pubDatetime.getTime();

const tz = postTimezone ?? SITE.timezone;
const datetime = dayjs(isModified ? modDatetime : pubDatetime).tz(tz);

const date = datetime.format('D MMM, YYYY');
const readingTimeMinutes = getReadingTime(text);
---

<span
  class:list={[
    'flex items-center gap-2 text-sm text-foreground-muted',
    { 'text-base': size === 'lg' },
    className,
  ]}
>
  <time datetime={datetime.toISOString()} title={`Timezone: ${tz}`}>
    {isModified && <span class='italic'>Updated: </span>}
    {date}
  </time>
  <span aria-hidden='true'>Â·</span>
  <span>{readingTimeMinutes} min read</span>
</span>
