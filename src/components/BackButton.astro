---
import { Icon } from 'astro-icon/components';
import { SITE } from '@/site.config';
---

{
  SITE.showBackButton ? (
    <a
      id='back-button'
      href='/'
      class='flex w-fit items-center justify-start gap-1 px-2 text-foreground-primary/75 underline underline-offset-4 transition-colors hover:text-foreground-primary'
    >
      <Icon name='tabler:chevron-left' class='size-4' />
      Go back
    </a>
  ) : null
}

<script>
  import { SITE } from '@/site.config';

  const STORAGE_KEY = SITE.browserStorage.backUrl;

  const updateGoBackUrl = () => {
    const backBtn: HTMLAnchorElement | null =
      document.querySelector('#back-button');

    if (!backBtn) return;

    const backUrl = sessionStorage.getItem(STORAGE_KEY);
    const currentPath = window.location.pathname;

    if (backUrl) {
      if (backUrl !== currentPath) {
        backBtn.href = backUrl;
      } else {
        backBtn.href = '/';
      }
    }
  };

  const handlePageLoad = () => {
    requestAnimationFrame(() => {
      updateGoBackUrl();
      setTimeout(updateGoBackUrl, 10);
    });
  };

  const handleStorageChange = (e: StorageEvent) => {
    if (e.key === STORAGE_KEY && e.newValue) {
      updateGoBackUrl();
    }
  };

  const handleCustomStorageChange = () => {
    updateGoBackUrl();
  };

  document.addEventListener('astro:page-load', handlePageLoad);
  window.addEventListener('storage', handleStorageChange);

  document.addEventListener('backUrlUpdated', handleCustomStorageChange);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handlePageLoad);
  } else {
    handlePageLoad();
  }
</script>
